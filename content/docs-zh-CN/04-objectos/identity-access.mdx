---
title: 身份与访问管理
description: ObjectOS 中的用户系统、RBAC 模型和字段级安全
---

# 身份与访问管理

ObjectOS 提供全面的身份与访问管理系统,包括内置的用户管理、基于角色的访问控制(RBAC)和字段级安全(FLS)。这使您能够构建具有细粒度权限的安全应用。

## 用户系统

ObjectOS 包含基于 `_users` 和 `_roles` 系统对象的内置用户系统。

### `_users` 对象

每个 ObjectOS 应用都有一个系统对象 `_users` 用于存储用户信息:

```typescript
// 内置 _users schema(系统对象)
{
  _users: {
    fields: {
      username: { type: 'text', required: true, unique: true },
      email: { type: 'email', required: true, unique: true },
      password: { type: 'password' },  // 自动加密
      name: { type: 'text' },
      profile: { type: 'lookup', reference_to: '_profiles' },
      roles: { type: 'lookup', reference_to: '_roles', multiple: true },
      active: { type: 'boolean', defaultValue: true },
      last_login: { type: 'datetime' },
      created: { type: 'datetime' },
      modified: { type: 'datetime' }
    }
  }
}
```

### 用户认证

ObjectOS 支持多种认证方式:

```typescript
const app = new ObjectOS({
  auth: {
    enabled: true,
    providers: {
      // 邮箱/密码认证
      email: {
        enabled: true,
        requireVerification: true,
        passwordPolicy: {
          minLength: 8,
          requireUppercase: true,
          requireNumbers: true,
          requireSpecialChars: false
        }
      },
      
      // OAuth 提供商
      oauth: {
        google: {
          clientId: process.env.GOOGLE_CLIENT_ID,
          clientSecret: process.env.GOOGLE_CLIENT_SECRET
        },
        github: {
          clientId: process.env.GITHUB_CLIENT_ID,
          clientSecret: process.env.GITHUB_CLIENT_SECRET
        }
      },
      
      // SSO/SAML
      saml: {
        enabled: false,
        entryPoint: 'https://sso.example.com',
        cert: process.env.SAML_CERT
      }
    },
    
    // Session 配置
    session: {
      secret: process.env.SESSION_SECRET,
      maxAge: 86400000,  // 24 小时
      secure: true,
      sameSite: 'strict'
    }
  }
})
```

### 用户注册

```typescript
// 注册新用户
const newUser = await app.auth.register({
  username: 'john_doe',
  email: 'john@example.com',
  password: 'SecurePass123',
  name: 'John Doe'
})

// 用户自动在 _users 对象中创建
// 密码使用 bcrypt 加密
```

### 用户登录

```typescript
// 邮箱/密码登录
const session = await app.auth.login({
  email: 'john@example.com',
  password: 'SecurePass123'
})

// 返回 session token
console.log(session.token)
console.log(session.user)
```

## 基于角色的访问控制(RBAC)

ObjectOS 使用 `_roles` 对象实现灵活的 RBAC 系统。

### `_roles` 对象

```typescript
// 内置 _roles schema(系统对象)
{
  _roles: {
    fields: {
      name: { type: 'text', required: true, unique: true },
      label: { type: 'text' },
      description: { type: 'text' },
      permissions: { type: 'json' },  // 权限定义
      users: { type: 'lookup', reference_to: '_users', multiple: true },
      created: { type: 'datetime' },
      modified: { type: 'datetime' }
    }
  }
}
```

### 创建角色

```typescript
// 创建管理员角色
await app.mutation('_roles', {
  action: 'insert',
  data: {
    name: 'admin',
    label: '管理员',
    description: '完整系统访问权限',
    permissions: {
      // 对象级权限
      objects: {
        '*': {  // 所有对象
          allowCreate: true,
          allowRead: true,
          allowEdit: true,
          allowDelete: true
        }
      },
      // 系统权限
      system: {
        manageUsers: true,
        manageRoles: true,
        viewAuditLog: true
      }
    }
  }
})

// 创建普通用户角色
await app.mutation('_roles', {
  action: 'insert',
  data: {
    name: 'user',
    label: '普通用户',
    description: '基本访问权限',
    permissions: {
      objects: {
        tasks: {
          allowCreate: true,
          allowRead: true,
          allowEdit: "owner eq $user.id",  // 只能编辑自己的任务
          allowDelete: "owner eq $user.id"
        },
        projects: {
          allowCreate: false,
          allowRead: true,
          allowEdit: false,
          allowDelete: false
        }
      }
    }
  }
})
```

### 为用户分配角色

```typescript
// 为用户分配角色
await app.mutation('_users', {
  action: 'update',
  _id: userId,
  data: {
    roles: [adminRoleId, userRoleId]
  }
})

// 用户可以拥有多个角色
// 权限会合并(最宽松的权限生效)
```

### 权限 Schema

ObjectOS 支持丰富的权限表达式:

```typescript
{
  permissions: {
    objects: {
      // 特定对象
      contacts: {
        // 布尔权限
        allowCreate: true,
        allowRead: true,
        
        // 条件权限(过滤表达式)
        allowEdit: "owner eq $user.id or assigned_to eq $user.id",
        allowDelete: "owner eq $user.id",
        
        // 字段级权限(见 FLS 部分)
        fieldPermissions: {
          salary: {
            allowRead: "$user.role eq 'hr'",
            allowEdit: "$user.role eq 'hr'"
          }
        }
      },
      
      // 所有对象的通配符
      '*': {
        allowRead: true
      }
    },
    
    // 系统级权限
    system: {
      manageUsers: false,
      manageRoles: false,
      viewAuditLog: false,
      exportData: false
    }
  }
}
```

## 字段级安全(FLS)

字段级安全允许您根据用户权限隐藏或保护敏感字段。

### 定义字段级安全

在 schema 中定义 FLS:

```typescript
const schema = {
  objects: {
    employees: {
      fields: {
        name: { type: 'text' },
        email: { type: 'email' },
        department: { type: 'text' },
        
        // 敏感字段
        salary: { 
          type: 'number',
          security: {
            read: "$user.role eq 'hr' or $user.role eq 'admin'",
            edit: "$user.role eq 'hr'"
          }
        },
        
        // 高度敏感字段
        ssn: {
          type: 'text',
          security: {
            read: "$user.role eq 'admin'",
            edit: false  // 永不可编辑
          }
        }
      }
    }
  }
}
```

### FLS 行为

当应用 FLS 时:

```typescript
// HR 用户查询员工
const employees = await app.query('employees', {}, { user: hrUser })

// 结果包含 salary 字段:
// [
//   { name: 'John', email: 'john@ex.com', salary: 50000, ... }
// ]

// 普通用户查询员工
const employees = await app.query('employees', {}, { user: regularUser })

// 结果不包含 salary 字段:
// [
//   { name: 'John', email: 'john@ex.com', ... }
// ]
// 字段完全隐藏,而不只是为 null
```

### 角色权限中的 FLS

您也可以在角色权限中定义 FLS:

```typescript
await app.mutation('_roles', {
  action: 'insert',
  data: {
    name: 'sales',
    label: '销售团队',
    permissions: {
      objects: {
        customers: {
          allowRead: true,
          allowEdit: "owner eq $user.id",
          
          // 字段级权限
          fieldPermissions: {
            credit_card: {
              allowRead: false,  // 永远看不到信用卡
              allowEdit: false
            },
            internal_notes: {
              allowRead: "$user.department eq 'sales'",
              allowEdit: "$user.role eq 'sales_manager'"
            }
          }
        }
      }
    }
  }
})
```

## 权限评估

ObjectOS 按以下顺序评估权限:

### 1. 系统对象保护

```typescript
// 系统对象(_users、_roles 等)有默认保护
// 默认只有管理员可以访问
```

### 2. 对象级权限

```typescript
// 检查用户是否可以对对象执行操作
if (!hasPermission(user, 'contacts', 'read')) {
  throw new PermissionError('无法读取联系人')
}
```

### 3. 记录级权限

```typescript
// 基于条件权限过滤记录
const filters = buildPermissionFilters(user, 'contacts', 'read')
// 例如: [['owner', 'eq', user.id], 'or', ['public', 'eq', true]]
```

### 4. 字段级安全

```typescript
// 移除用户无法访问的字段
const visibleFields = filterFieldsByPermissions(user, 'contacts', fields)
```

### 权限上下文变量

权限表达式中可用的变量:

```typescript
// 权限表达式上下文
{
  $user: {
    id: 'user_id',
    username: 'john_doe',
    email: 'john@example.com',
    role: 'admin',  // 主要角色
    roles: ['admin', 'user'],  // 所有角色
    department: 'engineering',
    // ... 自定义用户字段
  },
  
  $record: {
    // 当前访问的记录
    owner: 'record_owner_id',
    status: 'active',
    // ... 所有记录字段
  }
}

// 权限表达式示例:
"owner eq $user.id"                          // 用户拥有记录
"$user.role eq 'admin'"                      // 用户是管理员
"status eq 'published' or owner eq $user.id" // 已发布或拥有
"department eq $user.department"             // 同部门
```

## 高级场景

### 分层角色

```typescript
// 定义角色层次
const roles = [
  {
    name: 'admin',
    inherits: []  // 顶层
  },
  {
    name: 'manager',
    inherits: ['user']  // 拥有所有用户权限加更多
  },
  {
    name: 'user',
    inherits: []
  }
]
```

### 动态权限

```typescript
// 运行时计算权限
const schema = {
  objects: {
    documents: {
      permission_set: {
        user_permission: {
          allowRead: async (user, record) => {
            // 自定义逻辑
            if (record.public) return true
            if (record.owner === user.id) return true
            
            // 检查团队成员
            const team = await app.query('teams', {
              filters: [
                ['members', 'contains', user.id],
                ['documents', 'contains', record.id]
              ]
            })
            
            return team.length > 0
          }
        }
      }
    }
  }
}
```

### 审计日志

```typescript
const app = new ObjectOS({
  audit: {
    enabled: true,
    logLevel: 'all',  // 'all', 'mutations', 'sensitive'
    logFields: true,  // 记录字段级变更
    retention: 90     // 保留日志天数
  }
})

// 查询审计日志
const auditLog = await app.query('_audit_log', {
  filters: [
    ['user_id', 'eq', userId],
    ['action', 'eq', 'delete']
  ],
  sort: 'created desc'
})
```

## 安全最佳实践

### 1. 最小权限原则

```typescript
// 从最小权限开始
// 根据需要授予额外权限
permissions: {
  objects: {
    '*': {
      allowRead: false,
      allowCreate: false,
      allowEdit: false,
      allowDelete: false
    },
    // 只授予需要的权限
    tasks: {
      allowRead: true,
      allowCreate: true
    }
  }
}
```

### 2. 保护敏感字段

```typescript
// 始终对敏感数据使用 FLS
{
  password: { 
    type: 'password',
    security: {
      read: false,   // 永不可读
      edit: false    // 只能通过特殊 API
    }
  },
  api_key: {
    type: 'text',
    security: {
      read: "$user.id eq $record.owner",
      edit: "$user.id eq $record.owner"
    }
  }
}
```

### 3. 定期权限审计

```typescript
// 定期审查角色权限
const roles = await app.query('_roles', {})

for (const role of roles) {
  console.log(`角色: ${role.name}`)
  console.log(JSON.stringify(role.permissions, null, 2))
  
  // 检查过度宽松的设置
  if (role.permissions.objects['*']?.allowDelete) {
    console.warn('⚠️  角色拥有通配符删除权限')
  }
}
```

## 下一步

现在您已经理解了身份与访问管理:

- **[部署与运维](./deployment)** - 了解如何部署 ObjectOS 应用
- **[平台架构](./platform-architecture)** - 回顾平台架构
