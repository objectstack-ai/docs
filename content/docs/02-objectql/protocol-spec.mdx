---
title: Protocol Specification
description: Complete reference for Schema definition, Query DSL, and Aggregation operations
---

# Protocol Specification

This document provides the complete specification for ObjectQL's Schema definition language, Query DSL, and Aggregation operations.

## Schema Definition

### Object Definition

An object represents a database table:

```typescript
{
  objects: {
    [objectName: string]: {
      label?: string              // Display name
      icon?: string               // UI icon
      enable_files?: boolean      // Enable file attachments
      enable_search?: boolean     // Enable full-text search
      enable_tasks?: boolean      // Enable task tracking
      enable_notes?: boolean      // Enable notes
      enable_api?: boolean        // Expose via API (default: true)
      enable_share?: boolean      // Enable record sharing
      fields: { /* field definitions */ }
      list_views?: { /* view definitions */ }
      triggers?: { /* trigger definitions */ }
      actions?: { /* action definitions */ }
      permissions?: { /* permission definitions */ }
    }
  }
}
```

### Field Types Reference

#### Text Fields

```typescript
{
  // Short text (VARCHAR)
  field_name: {
    type: 'text',
    label?: string,
    defaultValue?: string,
    required?: boolean,
    unique?: boolean,
    index?: boolean,
    minLength?: number,
    maxLength?: number,
    pattern?: string        // Regex pattern
  },
  
  // Long text (TEXT)
  description: {
    type: 'textarea',
    rows?: number           // UI hint for rows
  },
  
  // Rich HTML content
  content: {
    type: 'html'
  },
  
  // Email with validation
  email: {
    type: 'email',
    unique?: boolean
  },
  
  // URL with validation
  website: {
    type: 'url'
  }
}
```

#### Numeric Fields

```typescript
{
  // Integer
  quantity: {
    type: 'number',
    scale: 0,               // No decimals
    min?: number,
    max?: number,
    defaultValue?: number
  },
  
  // Decimal
  price: {
    type: 'currency',
    scale: 2,               // 2 decimal places
    precision?: number      // Total digits (default: 15)
  },
  
  // Percentage
  discount: {
    type: 'percent',
    scale: 2
  },
  
  // Auto-number (sequence)
  invoice_number: {
    type: 'autonumber',
    formula: 'INV-{0000}'   // Format pattern
  }
}
```

#### Date and Time Fields

```typescript
{
  // Date only (YYYY-MM-DD)
  birth_date: {
    type: 'date',
    min?: string,           // '1900-01-01'
    max?: string            // '2100-12-31'
  },
  
  // Date and time
  created_at: {
    type: 'datetime',
    defaultValue?: string | (() => Date)
  },
  
  // Time only
  start_time: {
    type: 'time'
  }
}
```

#### Boolean and Select Fields

```typescript
{
  // Boolean checkbox
  is_active: {
    type: 'boolean',
    defaultValue?: boolean
  },
  
  // Single select (dropdown)
  status: {
    type: 'select',
    options: [
      { label: 'Draft', value: 'draft' },
      { label: 'Published', value: 'published' }
    ],
    // Or simple array
    // options: ['draft', 'published', 'archived']
    defaultValue?: string
  },
  
  // Multi-select
  tags: {
    type: 'multiSelect',
    options: ['urgent', 'important', 'low-priority']
  }
}
```

#### Relationship Fields

```typescript
{
  // Master-Detail (required foreign key)
  // Child record deleted when parent deleted
  account: {
    type: 'master_detail',
    reference_to: 'account',
    required: true,
    on_delete?: 'cascade' | 'restrict'  // Default: cascade
  },
  
  // Lookup (optional foreign key)
  // Relationship preserved when parent deleted
  manager: {
    type: 'lookup',
    reference_to: 'user',
    reference_to_field?: '_id'  // Default: _id
  },
  
  // Formula field (computed)
  full_name: {
    type: 'formula',
    formula: '{first_name} {last_name}',
    data_type: 'text'
  },
  
  // Summary (rollup from related records)
  total_opportunities: {
    type: 'summary',
    summary_object: 'opportunity',
    summary_type: 'count',
    summary_field: '_id',
    summary_filters: [['stage', '=', 'closed_won']]
  }
}
```

#### Special Fields

```typescript
{
  // File attachment
  avatar: {
    type: 'image',
    accept?: string         // 'image/*'
  },
  
  // Multiple files
  attachments: {
    type: 'filesize',
    multiple?: boolean      // Allow multiple files
  },
  
  // JSON data
  metadata: {
    type: 'json',
    schema?: object         // JSON Schema for validation
  },
  
  // Geolocation
  location: {
    type: 'location'        // Stores { lat, lng, address }
  },
  
  // Markdown content
  notes: {
    type: 'markdown'
  }
}
```

### Field Constraints

```typescript
{
  field_name: {
    type: 'text',
    
    // Validation
    required: boolean,      // NOT NULL
    unique: boolean,        // UNIQUE constraint
    index: boolean,         // Create index
    
    // Text constraints
    minLength: number,
    maxLength: number,
    pattern: string,        // Regex
    
    // Numeric constraints
    min: number,
    max: number,
    scale: number,          // Decimal places
    precision: number,      // Total digits
    
    // Default value
    defaultValue: any | (() => any),
    
    // Visibility
    hidden: boolean,        // Hide from UI
    readonly: boolean,      // Read-only
    
    // Dependencies
    depends_on: string[],   // Field dependencies
    visible_on: string      // Conditional visibility
  }
}
```

## Query DSL

### Basic Query

```typescript
db.query(objectName: string, options: QueryOptions): Promise<Record[]>

interface QueryOptions {
  fields?: string[]           // Fields to return
  filters?: Filter[]          // WHERE conditions
  sort?: string | Sort[]      // ORDER BY
  limit?: number              // LIMIT
  skip?: number               // OFFSET
  top?: number                // Alternative to limit
}
```

### Filters

Filter syntax: `[field, operator, value]`

#### Comparison Operators

```typescript
// Equal
['status', '=', 'active']
['status', 'eq', 'active']

// Not equal
['status', '!=', 'archived']
['status', 'ne', 'archived']

// Greater than
['age', '>', 18]
['age', 'gt', 18]

// Greater than or equal
['age', '>=', 18]
['age', 'gte', 18]

// Less than
['price', '<', 100]
['price', 'lt', 100]

// Less than or equal
['price', '<=', 100]
['price', 'lte', 100]
```

#### String Operators

```typescript
// Contains (case-insensitive)
['name', 'contains', 'john']
['name', 'like', '%john%']

// Starts with
['email', 'startswith', 'admin']
['email', 'like', 'admin%']

// Ends with
['domain', 'endswith', '.com']
['domain', 'like', '%.com']

// Not contains
['name', 'notcontains', 'test']
['name', 'not like', '%test%']
```

#### List Operators

```typescript
// In list
['status', 'in', ['draft', 'published']]

// Not in list
['status', 'notin', ['archived', 'deleted']]

// Between
['age', 'between', [18, 65]]
```

#### Null Operators

```typescript
// Is null
['description', '=', null]
['description', 'is null']

// Is not null
['description', '!=', null]
['description', 'is not null']
```

#### Compound Filters

```typescript
// AND (default)
filters: [
  ['status', '=', 'active'],
  ['age', '>', 18]
]
// WHERE status = 'active' AND age > 18

// OR
filters: [
  'or',
  ['status', '=', 'active'],
  ['status', '=', 'pending']
]
// WHERE status = 'active' OR status = 'pending'

// Complex combinations
filters: [
  'and',
  ['category', '=', 'electronics'],
  [
    'or',
    ['price', '<', 100],
    ['on_sale', '=', true]
  ]
]
// WHERE category = 'electronics' AND (price < 100 OR on_sale = true)
```

### Sorting

```typescript
// Simple string
sort: 'name'              // ASC by default
sort: 'name asc'
sort: 'price desc'

// Multiple fields
sort: 'category asc, price desc'

// Array syntax
sort: [
  { field: 'category', order: 'asc' },
  { field: 'price', order: 'desc' }
]
```

### Pagination

```typescript
// Limit and skip
{
  limit: 10,
  skip: 20    // Skip first 20 records
}

// Page-based
{
  top: 10,              // Records per page
  skip: pageNumber * 10
}

// Example: Get page 3 with 25 records per page
{
  limit: 25,
  skip: 2 * 25  // Skip first 50 (pages 1 & 2)
}
```

### Field Selection

```typescript
// Select specific fields
{
  fields: ['name', 'email', 'created']
}

// Select related fields
{
  fields: ['name', 'owner.name', 'owner.email']
}

// All fields (default)
{
  fields: ['*']
}
```

### Complete Query Example

```typescript
const results = await db.query('opportunity', {
  fields: ['name', 'amount', 'stage', 'account.name'],
  filters: [
    'and',
    ['stage', 'in', ['prospecting', 'qualification']],
    ['amount', '>', 10000],
    [
      'or',
      ['owner', '=', currentUserId],
      ['team', 'contains', currentUserId]
    ]
  ],
  sort: [
    { field: 'amount', order: 'desc' },
    { field: 'created', order: 'asc' }
  ],
  limit: 50,
  skip: 0
})
```

## Aggregation Operations

### GroupBy

```typescript
db.aggregate(objectName: string, options: AggregateOptions)

interface AggregateOptions {
  group_by: string[]
  having?: Filter[]
  fields?: AggregateField[]
  sort?: string | Sort[]
  limit?: number
}
```

#### Basic GroupBy

```typescript
// Count by category
await db.aggregate('product', {
  group_by: ['category'],
  fields: [
    { field: '_id', function: 'count', alias: 'total' }
  ]
})

// Result: [
//   { category: 'Electronics', total: 45 },
//   { category: 'Books', total: 123 }
// ]
```

#### Multiple Groupings

```typescript
// Sales by year and quarter
await db.aggregate('order', {
  group_by: ['YEAR(created)', 'QUARTER(created)'],
  fields: [
    { field: 'amount', function: 'sum', alias: 'total_sales' },
    { field: '_id', function: 'count', alias: 'order_count' }
  ],
  sort: 'YEAR(created) desc, QUARTER(created) desc'
})
```

### Aggregate Functions

```typescript
// Count
{ field: '_id', function: 'count' }

// Sum
{ field: 'amount', function: 'sum' }

// Average
{ field: 'price', function: 'avg' }

// Min
{ field: 'price', function: 'min' }

// Max
{ field: 'price', function: 'max' }

// Distinct count
{ field: 'customer_id', function: 'count_distinct' }
```

### Having Clause

Filter aggregated results:

```typescript
await db.aggregate('order', {
  group_by: ['customer_id'],
  fields: [
    { field: 'amount', function: 'sum', alias: 'total_spent' },
    { field: '_id', function: 'count', alias: 'order_count' }
  ],
  having: [
    ['total_spent', '>', 1000]    // Only customers who spent > 1000
  ]
})
```

### Complete Aggregation Example

```typescript
// Monthly sales report with filters
const monthlySales = await db.aggregate('invoice', {
  // Pre-aggregation filters (WHERE clause)
  filters: [
    ['status', '=', 'paid'],
    ['created', '>=', '2024-01-01']
  ],
  
  // Group by
  group_by: ['YEAR(created)', 'MONTH(created)'],
  
  // Aggregate calculations
  fields: [
    { field: 'amount', function: 'sum', alias: 'revenue' },
    { field: '_id', function: 'count', alias: 'invoice_count' },
    { field: 'amount', function: 'avg', alias: 'avg_invoice' },
    { field: 'customer_id', function: 'count_distinct', alias: 'unique_customers' }
  ],
  
  // Post-aggregation filters (HAVING clause)
  having: [
    ['revenue', '>', 50000]  // Only months with revenue > 50k
  ],
  
  // Sort results
  sort: 'YEAR(created) desc, MONTH(created) desc',
  
  // Limit results
  limit: 12  // Last 12 months
})

// Result: [
//   {
//     year: 2024,
//     month: 3,
//     revenue: 125000,
//     invoice_count: 45,
//     avg_invoice: 2777.78,
//     unique_customers: 32
//   },
//   ...
// ]
```

## Mutation Operations

### Insert

```typescript
await db.mutation('customer', {
  action: 'insert',
  data: {
    name: 'Acme Corp',
    email: 'contact@acme.com',
    status: 'active'
  }
})
```

### Update

```typescript
await db.mutation('customer', {
  action: 'update',
  filters: [['_id', '=', customerId]],
  data: {
    status: 'inactive',
    modified: new Date()
  }
})
```

### Delete

```typescript
await db.mutation('customer', {
  action: 'delete',
  filters: [['status', '=', 'archived']]
})
```

### Batch Operations

```typescript
// Batch insert
await db.mutation('product', {
  action: 'insert',
  data: [
    { name: 'Product 1', price: 10 },
    { name: 'Product 2', price: 20 },
    { name: 'Product 3', price: 30 }
  ]
})

// Batch update
await db.mutation('task', {
  action: 'update',
  filters: [['project_id', '=', projectId]],
  data: { status: 'cancelled' }
})
```

## Next Steps

- Explore [Core Features](./core-features) for performance optimizations
- Master the [Server SDK](./server-sdk) API reference
- Check [Core Concepts](./core-concepts) for foundational knowledge
