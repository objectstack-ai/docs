---
title: 架构全景
description: 理解 ObjectStack 三位一体。ObjectQL、ObjectOS 和 ObjectUI 如何协作构建企业内核。
---

# 架构全景

ObjectStack 不是一个单体框架。它是一个围绕**分层架构**设计的可组合生态系统。我们称之为 **"ObjectStack 三位一体"**。

每一层都是解耦的,并通过标准的 JSON 协议进行通信。这使得你可以替换实现(例如,将 React 渲染器替换为 Flutter 渲染器),而不会破坏堆栈的其余部分。



## 三位一体

### 1. 数据层: ObjectQL
**"通用协议"**

基础层是 ObjectQL。它负责**数据定义**和**数据访问**。

* **角色:** 定义*结构*(Schema)和*意图*(Query AST)。
* **职责:** 它知道 "Customer" 对象长什么样,但它不知道*谁*在访问它或*如何*显示它。
* **核心组件:** **编译器**。它接收抽象查询(`find customers where active = true`)并将其转换为针对特定底层数据库(Postgres、SQLite、MySQL)的优化 SQL。

### 2. 控制层: ObjectOS
**"业务内核"**

位于中间的是 ObjectOS。它负责**编排**和**治理**。

* **角色:** 管理请求的*生命周期*。
* **职责:**
    * **身份:** "这个用户是谁?"(身份验证)。
    * **安全:** "他们能看到这个字段吗?"(RBAC/ACL)。
    * **同步:** "我们如何合并这些离线更改?"(冲突解决)。
    * **流程:** "保存这条记录后会发生什么?"(工作流/触发器)。
* **核心概念:** 它充当网关。不允许直接访问数据库;所有操作都必须通过 OS 内核。

### 3. 视图层: ObjectUI
**"投影引擎"**

顶层是 ObjectUI。它负责**交互**和**渲染**。

* **角色:** 消费协议来渲染界面。
* **职责:** 它不包含硬编码的表单。相反,它询问 ObjectQL:*"Customer 的 Schema 是什么?"*,然后根据该元数据动态渲染布局。
* **核心概念:** **服务端驱动 UI (SDUI)**。后端决定布局、验证规则和可用操作。前端仅仅是一个高性能的渲染器。

---

## 请求生命周期

为了理解这些部分如何协同工作,让我们追踪一个典型的用户交互——例如,销售代表在离线状态下更新交易状态。

### 步骤 1: 交互 (ObjectUI)
用户在 UI 中点击 "标记为成功"。
* **ObjectUI** 根据 JSON Schema(本地加载)验证输入。
* 它不会立即发送 API 请求。它将更改写入**本地数据库**(例如 SQLite/RxDB)。
* UI 立即更新(0ms 延迟)。

### 步骤 2: 同步 (ObjectOS Sync)
当网络可用时,客户端向服务器推送 "变更包"。
* **ObjectOS** 接收数据包。
* 它验证会话身份(`@objectos/auth`)。
* 它检查**审计日志**以查找冲突(例如,5 分钟前是否有其他人编辑了这笔交易?)。
* 它运行任何服务端**工作流**逻辑(例如,"如果交易 > $10k,触发经理审批")。

### 步骤 3: 编译 (ObjectQL)
一旦 ObjectOS 批准请求,它将数据操作传递给 ObjectQL。
* **ObjectQL** 接收 AST:`UPDATE Deals SET Status = 'Won' WHERE ID = '123'`。
* **编译器**将其转换为目标方言:`UPDATE "deals" SET "status" = 'Won'...`。
* **驱动程序**针对主 PostgreSQL 数据库执行 SQL。

---

## 部署拓扑

由于架构是协议驱动的,它支持各种部署模型,具体取决于你的基础设施需求。

### A. 单体架构(默认)
适用于中小型企业应用。
* **前端:** React 单页应用(SPA)。
* **后端:** 运行 ObjectOS + ObjectQL Core 的单个 Node.js 实例。
* **数据库:** 单个 PostgreSQL 实例。

### B. 本地优先 / 边缘
适用于现场服务应用、POS 系统和高性能 SaaS。
* **前端:** ObjectUI + 嵌入式 ObjectQL(Wasm)+ SQLite。
* **后端:** ObjectOS 作为同步网关运行(无状态)。
* **数据库:** 分布式 SQL 或简单的对象存储用于复制日志。

### C. 微服务联邦
适用于大规模企业集成。
* 多个 ObjectOS 实例(CRM 服务、ERP 服务、HR 服务)。
* 集中式**网关**将 ObjectQL Schema 聚合成 "超级图"(类似于 GraphQL Federation)。
* ObjectUI 通过消费联邦 Schema 渲染统一的仪表板。
