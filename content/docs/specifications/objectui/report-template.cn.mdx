---
title: 报告和 PDF 协议
description: 使用 HTML/CSS 模板生成像素级完美可打印文档（发票、合同）的规范。
---

# 报告和 PDF 协议

在企业软件中，生成**像素级完美文档**的能力——发票、装箱单、合同和采购订单——至关重要。

ObjectUI 放弃了专有二进制格式（如 Crystal Reports），转而采用**标准网络技术**。我们使用 HTML/CSS 进行布局和模板引擎（Handlebars/Liquid）进行数据注入，在服务器端渲染为 PDF。

## 1. 模板定义

报告模板存储为元数据记录。它定义输出文档的结构和样式。

### Schema 结构

```yaml
# templates/invoice.report.yml
name: invoice_standard
label: Standard Invoice (A4)
object: invoice          # 数据上下文
engine: handlebars       # 或 'liquid'
orientation: portrait
format: A4
header_height: 30mm
footer_height: 20mm

```

### 布局（HTML + CSS）

ObjectUI 依赖**分页媒体 CSS**（`@page`）来控制物理纸张属性。

```html
<div class="invoice-box">
  <table cellpadding="0" cellspacing="0">
    <tr class="top">
      <td class="title">
        <img src="{{company.logo_url}}" style="width:100%; max-width:300px;">
      </td>
      <td>
        Invoice #: {{record.name}}<br>
        Created: {{formatDate record.created_at "YYYY-MM-DD"}}<br>
      </td>
    </tr>
  </table>
  
  <table class="items">
    <tr class="heading">
      <td>Item</td>
      <td>Price</td>
    </tr>
    {{#each record.lines}}
    <tr class="item">
      <td>{{this.product_name}}</td>
      <td>{{formatCurrency this.amount}}</td>
    </tr>
    {{/each}}
  </table>
</div>

```

```css
/* 样式模板 */
@page {
  size: A4;
  margin: 20mm;
}
.invoice-box {
  max-width: 800px;
  margin: auto;
  font-family: 'Helvetica Neue', 'Helvetica', Helvetica, Arial, sans-serif;
}
/* ... 标准 CSS ... */

```

## 2. 数据上下文

生成报告时，ObjectQL 引擎准备**上下文对象**。这是模板变量 `{{...}}` 可用的数据。

### 自动上下文

1. **`record`**: 正在打印的当前记录（例如，发票）。
2. **`user`**: 生成报告的用户（例如，"由 Alice 打印"）。
3. **`company`**: 全局租户设置（徽标、地址、税号）。
4. **`related`**: 如果配置，ObjectQL 自动获取相关列表（例如，`invoice.lines`）。

### 数据获取配置

你可以定义 ObjectQL 查询来注入不直接在记录上的复杂数据。

```yaml
# 在报告定义中
data_query:
  lines: 
    object: invoice_line
    filters: [["invoice_id", "=", "${record._id}"]]
    sort: [["line_number", "asc"]]
  history:
    object: payment_history
    filters: [["invoice_id", "=", "${record._id}"]]

```

## 3. 生成协议

客户端如何请求 PDF？它发送标准动作。

### 单个记录打印

最常见的用例："打印此发票"。

```json
{
  "action": "report.generate",
  "params": {
    "template": "invoice_standard",
    "record_id": "inv_12345",
    "format": "pdf", // pdf, html, png
    "download": true // true = 文件下载, false = 在新标签页打开
  }
}

```

### 批量打印

将多条记录打印到单个合并 PDF 中（例如，"打印本月的所有发票"）。

```json
{
  "action": "report.generate_batch",
  "params": {
    "template": "packing_slip",
    "filters": [["status", "=", "ready_to_ship"]],
    "sort": [["customer_name", "asc"]]
  }
}

```

## 4. 特殊功能

### 条形码和二维码

企业报告通常需要机器可读的代码。渲染引擎提供内置帮助程序。

* **语法：** `{{qrCode record.tracking_number size=100}}`
* **语法：** `{{barcode record.sku type="code128"}}`

### 水印

用于草稿或机密文档。

```yaml
watermark:
  text: "DRAFT"
  opacity: 0.1
  color: "#FF0000"
  rotation: -45
  condition: "record.status != 'paid'" # 逻辑驱动

```

### 数字签名

协议支持电子签名集成（如 DocuSign）的占位符区域。

```html
<div class="signature-box" data-sign-role="customer">
  X __________________________
</div>

```

## 5. 架构：无头渲染

它在幕后如何工作？

1. **请求：** ObjectUI 向 ObjectOS 发送请求。
2. **数据：** ObjectOS 执行 ObjectQL 查询以获取数据上下文。
3. **合并：** 模板引擎（Handlebars）合并数据 + HTML。
4. **渲染：** ObjectOS 启动**无头浏览器**（例如，Puppeteer 或 Playwright）。
5. **打印：** 无头浏览器呈现 HTML 并执行 Chrome"打印为 PDF"函数。
6. **流：** 二进制 PDF 流发送回客户端。

## 总结

| 功能 | ObjectUI 协议 | 传统报告 |
| --- | --- | --- |
| **技术** | 标准 HTML/CSS | 专有布局 |
| **数据源** | ObjectQL 上下文 | 复杂 SQL 查询 |
| **逻辑** | Handlebars/Liquid | 专有脚本 |
| **输出** | PDF / HTML / 图像 | 仅 PDF |

:::tip 自定义
由于模板是 HTML/CSS，你可以让了解基本网络设计的最终用户自定义自己的发票布局，而无需专业开发人员。
:::
