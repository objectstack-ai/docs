---
title: 工作流引擎
description: 业务流程管理 (BPM) 协议。状态机、审批链和 BPMN 映射。
---

# 工作流引擎

**ObjectOS 工作流引擎**是一个确定性状态机，它控制业务对象的生命周期。

与即席脚本或分散的布尔标志不同，工作流协议将"道路规则"集中化。它确保 `Purchase Order` 不能在不经过 `Approved` 的情况下从 `Draft` 移动到 `Paid`。

## 1. 工作流协议（FSM）

从核心来说，工作流是在 YAML 中定义的**有限状态机 (FSM)**。

### 协议结构

```yaml
# workflows/contract_approval.workflow.yml
name: contract_process
object: contract
initial_state: draft
field: status  # 存储状态的对象上的字段

states:
  draft:
    allow_edit: true
    transitions:
      submit: pending_review
      
  pending_review:
    allow_edit: false
    transitions:
      approve: legal_review
      reject: draft
      
  legal_review:
    transitions:
      sign: active
      reject: draft
      
  active:
    final: true

```

### 关键组件

* **状态**：记录可以处于的不同阶段。
* **转换**：状态之间的有向路径（例如，`submit`）。
* **防护**：防止转换的规则（例如，"仅经理可以批准"）。
* **副作用**：在进入/退出时触发的操作（例如，"发送电子邮件"）。

## 2. 审批链（人工任务）

企业工作流通常需要人工干预。ObjectOS 提供了一个专门的**审批协议**来处理"谁需要签署此文件？"的复杂性。

### 指定审批人

您可以将 `approval` 块附加到任何状态。

```yaml
states:
  pending_review:
    type: approval
    approval:
      # 谁可以批准？
      participants: 
        - type: role
          id: manager
        - type: user
          id: "${record.department_head}" # 动态解析
          
      # 需要多少个签名？
      strategy: any # 'any'（1 人）或 'all'（共识）
      
    transitions:
      approve: active
      reject: draft

```

### "收件箱"概念

当记录进入 `approval` 状态时：

1. ObjectOS 为参与者生成**工作项**（任务）。
2. 这些项出现在用户的 ObjectUI 中的"我的批准"收件箱中。
3. 在做出决定之前，记录被严格**锁定**（只读）。

## 3. 自动化（服务任务）

并非所有步骤都是人工的。ObjectOS 支持自动执行代码或调用 API 的**服务任务**。

```yaml
states:
  processing_payment:
    type: service
    action: "finance.charge_credit_card"
    params:
      amount: "${record.amount}"
      token: "${record.payment_token}"
    transitions:
      success: paid
      failure: payment_failed

```

## 4. BPMN 2.0 映射

ObjectOS 被设计为与 **BPMN 2.0（业务流程模型和符号）** 兼容。这允许您使用可视化建模工具（如 Camunda Modeler 或 BPmn.io）来生成 ObjectOS YAML 协议。

| ObjectOS 概念 | BPMN 2.0 元素 | 描述 |
| --- | --- | --- |
| **工作流** | `Process` | 定义的容器。 |
| **状态** | `UserTask` / `Task` | 等待操作的停止点。 |
| **初始状态** | `StartEvent` | 入口点。 |
| **最终状态** | `EndEvent` | 完成点。 |
| **转换** | `SequenceFlow` | 连接节点的箭头。 |
| **防护** | `ExclusiveGateway` (XOR) | 菱形决策节点。 |
| **触发器** | `ServiceTask` | 自动逻辑执行。 |

## 5. 事件集成

工作流发出系统其他部分可以监听的事件。

* `workflow.state_changed`：每当状态移动时触发。
* `workflow.step_started`：进入状态时触发。
* `workflow.completed`：到达最终状态时触发。

### 示例：通知监听器

```typescript
// plugins/notifications/listeners.ts
broker.on('workflow.state_changed', async (ctx) => {
  const { object, record_id, to_state } = ctx.params;
  
  if (object === 'contract' && to_state === 'active') {
    await sendEmail(ctx.user.email, "Contract Signed!");
  }
});

```

## 6. 交互 API

前端如何与引擎交互？

### 1. 检查可用的转换

ObjectUI 询问："*我应该显示哪些按钮？*"

```json
// 请求
POST /api/workflow/permissions
{ "object": "contract", "id": "123" }

// 响应
{
  "allow_edit": false,
  "transitions": [
    { "name": "approve", "label": "Approve Contract", "variant": "success" },
    { "name": "reject", "label": "Send Back", "variant": "danger" }
  ]
}

```

### 2. 执行转换

用户点击"批准"。

```json
// 请求
POST /api/workflow/transition
{
  "object": "contract",
  "id": "123",
  "transition": "approve",
  "comment": "Looks good to me."
}

```

## 摘要

工作流引擎将"流程"变为"协议"。

* **确定性：** 消除无效的状态修改。
* **审计就绪：** 每个转换都以时间戳和用户身份记录。
* **可视化：** 与 BPMN 图表 1:1 映射，方便业务利益相关者。
* **集成：** 与 ObjectUI（按钮）和 ObjectQL（锁定）无缝配合。
