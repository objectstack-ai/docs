---
title: 插件清单
description: 打包能力的规范。清单结构、生命周期钩子和依赖项管理。
---

# 插件清单

ObjectOS 遵循**微内核架构**。核心引擎是极小的，仅提供基本运行时（Auth、DB 驱动程序、HTTP 服务器）。

所有业务功能——CRM、项目管理、人力资源以及甚至系统工具（如"文件存储"）——都作为**插件**提供。

插件是可部署单元（通常是 NPM 包），其中包含**清单文件**。此清单告诉内核插件对系统的确切贡献。

## 1. 清单结构（`plugin.config.yml`）

每个插件的入口点是其配置文件。这是模块的"身份证"。

```yaml
# plugin.config.yml
id: "@steedos/crm"
version: "2.4.0"
name: "Steedos CRM"
description: "Enterprise Customer Relationship Management suite."
author: "Steedos Labs"
license: "MIT"

# 1. 依赖项管理
dependencies:
  "@objectos/auth": "^1.0.0"
  "@steedos/common": "^2.0.0"

# 2. 贡献点（协议加载）
contributes:
  objects: 
    - "./objects/*.object.yml"
  apps:
    - "./apps/*.app.yml"
  workflows:
    - "./workflows/*.workflow.yml"
  permissions:
    - "./permissions/*.profile.yml"
  translations:
    - "./i18n/*.json"

# 3. 服务器端逻辑
entry: "./src/index.ts"

```

## 2. 贡献点

`contributes` 部分允许内核**自动发现**资源。您无需手动编写 `app.register(...)` 代码。

### 标准贡献

| 类型 | 描述 | 路径惯例 |
| --- | --- | --- |
| **对象** | 数据 Schema 定义。 | `src/objects/*.yml` |
| **应用** | 应用分组（菜单结构）。 | `src/apps/*.yml` |
| **触发器** | 后端逻辑钩子。 | `src/triggers/*.ts` |
| **API** | 自定义 REST/GraphQL 端点。 | `src/api/*.ts` |
| **客户端** | 自定义 UI 组件（React）。 | `src/client/index.tsx` |
| **资源** | 静态文件（图像、CSS）。 | `public/` |

### 扩展点

插件也可以定义*新的*贡献点。

* *示例：* "支付插件"可能会暴露 `payment_gateways` 贡献点，允许其他插件注册"Stripe"或"PayPal"适配器。

## 3. 插件生命周期

ObjectOS 严格管理插件的生命周期以确保稳定性。

### 生命周期接口（TypeScript）

如果您的插件需要在启动期间执行逻辑（例如，连接到 Redis、种子初始数据），您可以导出实现 `PluginLifecycle` 接口的类。

```typescript
// src/index.ts
import { Plugin, PluginContext } from '@objectos/types';

export default class CRMPlugin implements Plugin {
  
  /**
   * 阶段 1：加载
   * 验证配置。还不连接数据库。
   */
  async onLoad(ctx: PluginContext) {
    ctx.logger.info("CRM Plugin Loaded");
  }

  /**
   * 阶段 2：初始化（安装）
   * 当插件首次安装时运行一次。
   * 很好用于种子默认数据（例如，默认的"Lead Status"值）。
   */
  async onInstall(ctx: PluginContext) {
    await ctx.broker.call('data.create', {
      object: 'lead_status',
      data: { name: 'New', is_default: true }
    });
  }

  /**
   * 阶段 3：启动
   * 系统已准备好。连接到外部服务。
   */
  async onStart(ctx: PluginContext) {
    // 启动后台工作进程
    this.worker = new LeadScoringWorker();
    await this.worker.start();
  }

  /**
   * 阶段 4：停止
   * 优雅关闭。
   */
  async onStop(ctx: PluginContext) {
    await this.worker.stop();
  }
}

```

## 4. 资源隔离与命名空间

为了防止插件冲突（例如，两个插件都定义了 `settings` 对象），ObjectOS 强制执行命名空间约定。

* **全局命名空间：** 核心对象（`user`、`space`、`role`）。
* **插件命名空间：** 自定义对象应该加前缀，如果用于公开分发（例如，`stripe_payment_log`）。

但是，对于内部企业项目，通常会省略命名空间以获得更简单的 API。清单验证器在启动时检查 **ID 冲突**，如果两个插件声明相同的对象名称，则抛出 `硬错误`。

## 5. 配置与环境

插件应符合 12-因素应用标准。它们不应在代码中存储配置。

### 配置模式

插件可以声明它期望的配置。

```yaml
# plugin.config.yml
config_schema:
  stripe_key:
    type: string
    required: true
    secret: true
    description: "API Key from Stripe Dashboard"

```

### 注入

操作系统从环境变量或中央 `steedos-config.yml` 注入这些值。

* 环境变量：`STEEDOS_CRM_STRIPE_KEY=sk_test_...`
* 代码中的访问：`ctx.config.stripe_key`

## 6. 分发（NPM）

ObjectOS 插件是标准**NPM 包**。

### 开发流程

1. **创建：** `npm create objectos-plugin my-plugin`
2. **开发：** `npm run dev`（启动本地内核和热重载）。
3. **构建：** `npm run build`（将 TS 编译为 JS，验证 YAML）。
4. **发布：** `npm publish`（部署到私有或公开注册表）。

### 安装

要将插件添加到您的项目：

```bash
npm install @steedos/crm

```

然后将其添加到您的项目的 `steedos-config.yml`：

```yaml
plugins:
  - "@steedos/crm"

```

## 摘要

插件清单将代码变为**产品**。

| 特征 | 描述 |
| --- | --- |
| **清单** | 功能的声明性清单（`plugin.yml`）。 |
| **自动加载器** | 无需连接；只需将文件放在文件夹中。 |
| **生命周期** | 为健壮逻辑的结构化钩子（`onInstall`、`onStart`）。 |
| **配置** | 类型安全配置注入。 |
| **标准** | 基于 NPM 生态系统用于版本控制和分发。 |
