---
title: 审计与合规
description: 问责协议。字段历史跟踪、系统审计跟踪和数据保留策略。
---

# 审计与合规

在企业世界中，"谁改变了这个？"是最昂贵的问题。

ObjectOS 将**可审计性**视为一流公民。与您必须在控制器中手动写入日志的框架不同，ObjectOS 实现了**内核级审计**。如果变更通过 ObjectOS 引擎，它*将*被记录，无论它来自 UI、API 还是后台作业。

## 1. 数据历史跟踪（字段级）

此机制跟踪业务记录内的值更改。它回答："*Deal Amount 从 $10k 改变为 $5k 吗，谁做的？*"

### 配置（声明式）
您无需编写代码来启用此功能。您只需在 Schema 中标记对象或特定字段。

```yaml
# objects/deal.object.yml
name: deal
label: Sales Deal
enable_audit: true # 主开关

fields:
  name:
    type: text
  
  amount:
    type: currency
    track_history: true # 跟踪此特定字段的更改
    
  stage:
    type: select
    track_history: true
    
  description:
    type: textarea
    track_history: false # 不要跟踪大文本块（节省空间）

```

### 历史协议

当事务提交时，审计引擎计算**增量**并写入 `object_history` 存储。

```json
{
  "event_id": "evt_001",
  "timestamp": "2026-01-20T10:00:00Z",
  "actor": "user_123",
  "ip_address": "192.168.1.1",
  "object": "deal",
  "record_id": "deal_abc",
  "changes": [
    {
      "field": "amount",
      "old_value": 10000,
      "new_value": 5000
    },
    {
      "field": "stage",
      "old_value": "negotiation",
      "new_value": "closed_won"
    }
  ]
}

```

## 2. 设置审计跟踪（元数据级）

超越数据，您必须跟踪**系统配置**的更改。这防止了"影子 IT"修改，其中管理员悄悄降低安全设置。

ObjectOS 自动记录以下操作：

* **Schema：** 创建/删除对象或字段。
* **安全：** 更改权限集或共享规则。
* **逻辑：** 修改工作流或触发器。
* **用户：** 密码重置、角色分配。

### 示例日志条目

> **用户：** Alice（管理员）
> **操作：** 权限简介更新
> **目标：** Sales Rep 简介
> **更改：** `lead.export_permission` 从 `false` 改为 `true`。

## 3. 登录与访问日志

为了符合安全合规性，访问事件被单独跟踪。

* **登录成功/失败：** 跟踪时间戳、用户、IP、用户代理和身份验证方法（密码 vs. SSO）。
* **API 访问：** （可选）可以配置为在高安全环境中记录每个 API 调用（警告：高容量）。

## 4. 存储与保留策略

审计日志增长迅速。ObjectOS 提供了**保留协议**来有效地管理生命周期成本。

### 架构

审计数据**永不**与事务性数据存储在同一表中。

* **热存储（最后 30 天）：** 存储在主 SQL 数据库中以供 UI 即时访问。
* **冷存储（存档）：** 卸载到低成本对象存储 (S3/Parquet) 或专用日志服务 (Elasticsearch/Splunk)。

### 策略配置

```yaml
# config/audit_retention.yml
policies:
  - object: deal
    retention_period: 3650 # 10 年（财务规定）
    archive_after: 90 # 90 天后移至冷存储
    
  - object: task
    retention_period: 180 # 6 个月
    purge_after: 180 # 硬删除

```

## 5. 合规功能（GDPR/HIPAA）

### "被遗忘权"（GDPR）

当用户请求删除时，ObjectOS 提供 `System.anonymize` 实用程序。

* 它从 `users` 表中清除 PII（个人可识别信息）。
* **关键：** 它*不*删除审计日志行（用于法律完整性），但它掩盖 `actor` ID 或用"匿名用户"替换名称，确保历史完整性，同时尊重隐私。

### 不可变性

审计引擎被设计为**仅追加**。

* API 不为 `audit_log` 对象暴露 `UPDATE` 或 `DELETE` 端点。
* 即使系统管理员也无法通过标准 UI/API 删除审计跟踪（需要直接数据库访问，留下自己的痕迹）。

## 6. 快照（时间旅行）

对于高级场景，ObjectOS 支持**完整文档快照**。它不是存储差异，而是存储每次保存时记录的整个 JSON 版本。

* **用例：** 法律合同或医疗记录，您需要"查看记录在 2024 年 1 月 1 日时的确切样子"。
* **配置：** `enable_versioning: true`。

## 摘要

ObjectOS 审计协议确保您的应用"开箱即用"是企业就绪的。

1. **零代码：** 只需添加 `track_history: true`。
2. **精细：** 跟踪特定字段，而不仅仅是"修改日期"。
3. **治理：** 跟踪管理员（设置审计跟踪）。
4. **生命周期：** 自动存档和清除以管理数据库增长。
