---
title: 服务端 SDK 参考
description: ObjectQL 服务端 SDK 的完整 API 参考
---

# 服务端 SDK 参考

ObjectQL 服务端 SDK 的完整参考,涵盖初始化、查询方法、变更操作和高级功能。

## 安装

```bash
npm install @objectql/core
```

## 初始化

### new ObjectQL()

创建新的 ObjectQL 实例。

```typescript
import { ObjectQL } from '@objectql/core'

const db = new ObjectQL(options: ObjectQLOptions)
```

#### ObjectQLOptions

```typescript
interface ObjectQLOptions {
  // 数据库驱动
  driver: 'sqlite' | 'mysql' | 'postgresql' | 'mssql' | 'oracle'
  
  // 连接 URL
  url?: string
  
  // 或单独的连接参数
  host?: string
  port?: number
  user?: string
  password?: string
  database?: string
  
  // 驱动特定选项
  sqlite?: SQLiteOptions
  mysql?: MySQLOptions
  postgres?: PostgresOptions
  
  // ObjectQL 选项
  enableVirtualColumns?: boolean  // 默认: SQLite 为 true
  enableCache?: boolean           // 默认: true
  cacheSize?: number              // 默认: 1000
  logLevel?: 'debug' | 'info' | 'warn' | 'error'  // 默认: 'info'
}
```

#### 示例

**SQLite (本地开发):**

```typescript
const db = new ObjectQL({
  driver: 'sqlite',
  url: './data/myapp.db'
})
```

**MySQL (生产环境):**

```typescript
const db = new ObjectQL({
  driver: 'mysql',
  host: 'db.example.com',
  port: 3306,
  user: 'myapp',
  password: process.env.DB_PASSWORD,
  database: 'production',
  mysql: {
    connectionLimit: 20,
    waitForConnections: true,
    ssl: {
      ca: fs.readFileSync('./ca.pem')
    }
  }
})
```

**PostgreSQL (云端):**

```typescript
const db = new ObjectQL({
  driver: 'postgresql',
  url: process.env.DATABASE_URL,
  postgres: {
    max: 25,
    ssl: { rejectUnauthorized: false }
  }
})
```

## Schema 管理

### registerSchema()

向 ObjectQL 注册 Schema。

```typescript
await db.registerSchema(schema: Schema): Promise<void>
```

#### 参数

- `schema` - Schema 定义对象

#### 示例

```typescript
await db.registerSchema({
  objects: {
    customer: {
      label: '客户',
      fields: {
        name: { type: 'text', required: true },
        email: { type: 'email', unique: true },
        status: { 
          type: 'select', 
          options: ['active', 'inactive'],
          defaultValue: 'active'
        }
      }
    },
    order: {
      label: '订单',
      fields: {
        customer: {
          type: 'master_detail',
          reference_to: 'customer'
        },
        amount: { type: 'currency', scale: 2 },
        status: {
          type: 'select',
          options: ['pending', 'paid', 'cancelled']
        }
      }
    }
  }
})
```

### getSchema()

获取已注册的 Schema。

```typescript
const schema = db.getSchema(objectName?: string): Schema | ObjectSchema
```

#### 参数

- `objectName` - 可选。返回特定对象的 Schema

#### 示例

```typescript
// 获取整个 Schema
const allSchema = db.getSchema()

// 获取特定对象的 Schema
const customerSchema = db.getSchema('customer')
console.log(customerSchema.fields)
```

## 查询操作

### query()

从对象查询记录。

```typescript
const results = await db.query<T>(
  objectName: string,
  options?: QueryOptions
): Promise<T[]>
```

#### QueryOptions

```typescript
interface QueryOptions {
  fields?: string[]           // 要返回的字段
  filters?: Filter[]          // WHERE 条件
  sort?: string | Sort[]      // ORDER BY
  limit?: number              // LIMIT
  skip?: number               // OFFSET
  top?: number                // 替代 limit
}

type Filter = 
  | [string, Operator, any]           // 简单过滤器
  | ['and' | 'or', ...Filter[]]       // 复合过滤器

type Operator = 
  | '=' | '!=' | '>' | '>=' | '<' | '<=' 
  | 'eq' | 'ne' | 'gt' | 'gte' | 'lt' | 'lte'
  | 'in' | 'notin' | 'between'
  | 'contains' | 'startswith' | 'endswith' | 'notcontains'
  | 'like' | 'not like'
  | 'is null' | 'is not null'
```

#### 示例

**基本查询:**

```typescript
// 获取所有活跃客户
const customers = await db.query('customer', {
  filters: [['status', '=', 'active']]
})
```

**字段选择:**

```typescript
// 选择特定字段
const customers = await db.query('customer', {
  fields: ['_id', 'name', 'email'],
  filters: [['status', '=', 'active']]
})
```

**复杂过滤器:**

```typescript
// 复杂 AND/OR 条件
const orders = await db.query('order', {
  filters: [
    'and',
    ['status', 'in', ['pending', 'paid']],
    ['amount', '>', 100],
    [
      'or',
      ['customer.city', '=', '纽约'],
      ['customer.city', '=', '洛杉矶']
    ]
  ]
})
```

**排序和分页:**

```typescript
// 排序和分页
const page = 1
const pageSize = 25

const customers = await db.query('customer', {
  sort: [
    { field: 'created', order: 'desc' },
    { field: 'name', order: 'asc' }
  ],
  limit: pageSize,
  skip: (page - 1) * pageSize
})
```

**关联字段:**

```typescript
// 查询关联字段
const orders = await db.query('order', {
  fields: ['_id', 'amount', 'customer.name', 'customer.email'],
  filters: [['status', '=', 'pending']]
})

// 结果: [
//   { 
//     _id: '123', 
//     amount: 199.99, 
//     customer: { name: '张三', email: 'zhang@example.com' }
//   }
// ]
```

### queryOne()

查询单条记录。

```typescript
const record = await db.queryOne<T>(
  objectName: string,
  options?: QueryOptions
): Promise<T | null>
```

#### 示例

```typescript
// 按 ID 获取客户
const customer = await db.queryOne('customer', {
  filters: [['_id', '=', customerId]]
})

if (!customer) {
  throw new Error('客户不存在')
}
```

### count()

计算匹配过滤器的记录数。

```typescript
const total = await db.count(
  objectName: string,
  filters?: Filter[]
): Promise<number>
```

#### 示例

```typescript
// 计算活跃客户数
const activeCount = await db.count('customer', [
  ['status', '=', 'active']
])

// 总数
const totalCount = await db.count('customer')
```

## 变更操作

### mutation()

插入、更新或删除记录。

```typescript
const result = await db.mutation(
  objectName: string,
  options: MutationOptions
): Promise<MutationResult>
```

#### MutationOptions

```typescript
interface MutationOptions {
  action: 'insert' | 'update' | 'delete'
  data?: Record<string, any> | Record<string, any>[]
  filters?: Filter[]
}

interface MutationResult {
  success: boolean
  ids?: string[]        // 插入/更新的记录 ID
  count?: number        // 受影响的记录数
  errors?: Error[]
}
```

#### 插入示例

**单条插入:**

```typescript
const result = await db.mutation('customer', {
  action: 'insert',
  data: {
    name: 'Acme 公司',
    email: 'contact@acme.com',
    status: 'active'
  }
})

console.log(result.ids[0])  // 创建的记录 ID
```

**批量插入:**

```typescript
const result = await db.mutation('product', {
  action: 'insert',
  data: [
    { name: '产品 A', price: 29.99 },
    { name: '产品 B', price: 49.99 },
    { name: '产品 C', price: 79.99 }
  ]
})

console.log(result.count)  // 3
console.log(result.ids)    // ['id1', 'id2', 'id3']
```

#### 更新示例

**按 ID 更新:**

```typescript
await db.mutation('customer', {
  action: 'update',
  filters: [['_id', '=', customerId]],
  data: {
    status: 'inactive',
    notes: '账户已关闭'
  }
})
```

**批量更新:**

```typescript
// 停用特定城市的所有客户
await db.mutation('customer', {
  action: 'update',
  filters: [['city', '=', '旧城市']],
  data: {
    status: 'inactive'
  }
})
```

#### 删除示例

**按 ID 删除:**

```typescript
await db.mutation('customer', {
  action: 'delete',
  filters: [['_id', '=', customerId]]
})
```

**条件删除:**

```typescript
// 删除所有超过 1 年的已归档订单
const oneYearAgo = new Date()
oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1)

await db.mutation('order', {
  action: 'delete',
  filters: [
    ['status', '=', 'archived'],
    ['created', '<', oneYearAgo.toISOString()]
  ]
})
```

## 聚合操作

### aggregate()

执行聚合查询。

```typescript
const results = await db.aggregate(
  objectName: string,
  options: AggregateOptions
): Promise<AggregateResult[]>
```

#### AggregateOptions

```typescript
interface AggregateOptions {
  group_by: string[]              // GROUP BY 字段
  fields?: AggregateField[]       // 聚合计算
  filters?: Filter[]              // WHERE 子句
  having?: Filter[]               // HAVING 子句
  sort?: string | Sort[]          // ORDER BY
  limit?: number                  // LIMIT
}

interface AggregateField {
  field: string
  function: 'count' | 'sum' | 'avg' | 'min' | 'max' | 'count_distinct'
  alias?: string
}
```

#### 示例

**简单聚合:**

```typescript
// 按状态统计客户数
const statusCounts = await db.aggregate('customer', {
  group_by: ['status'],
  fields: [
    { field: '_id', function: 'count', alias: 'total' }
  ]
})

// 结果: [
//   { status: 'active', total: 150 },
//   { status: 'inactive', total: 23 }
// ]
```

**销售报告:**

```typescript
// 月度销售汇总
const monthlySales = await db.aggregate('order', {
  filters: [
    ['status', '=', 'paid'],
    ['created', '>=', '2024-01-01']
  ],
  group_by: ['YEAR(created)', 'MONTH(created)'],
  fields: [
    { field: 'amount', function: 'sum', alias: 'revenue' },
    { field: '_id', function: 'count', alias: 'order_count' },
    { field: 'amount', function: 'avg', alias: 'avg_order' },
    { field: 'customer_id', function: 'count_distinct', alias: 'unique_customers' }
  ],
  having: [
    ['revenue', '>', 10000]
  ],
  sort: 'YEAR(created) desc, MONTH(created) desc'
})
```

**客户消费:**

```typescript
// 消费最多的客户
const topCustomers = await db.aggregate('order', {
  group_by: ['customer_id'],
  fields: [
    { field: 'amount', function: 'sum', alias: 'total_spent' },
    { field: '_id', function: 'count', alias: 'order_count' }
  ],
  having: [
    ['total_spent', '>', 1000]
  ],
  sort: 'total_spent desc',
  limit: 10
})
```

## Virtual City

### virtualCity()

创建 Virtual City 实例用于多租户数据隔离。

```typescript
const tenantDb = db.virtualCity(spaceId: string): ObjectQL
```

#### 参数

- `spaceId` - 租户/空间的唯一标识符

#### 示例

```typescript
// 创建租户特定实例
const tenant1Db = db.virtualCity('tenant_001')
const tenant2Db = db.virtualCity('tenant_002')

// 每个租户只能看到自己的数据
await tenant1Db.mutation('customer', {
  action: 'insert',
  data: { name: '租户 1 客户' }
})

await tenant2Db.mutation('customer', {
  action: 'insert',
  data: { name: '租户 2 客户' }
})

// 租户 1 查询
const tenant1Customers = await tenant1Db.query('customer', {})
// 返回: [{ name: '租户 1 客户', space: 'tenant_001' }]

// 租户 2 查询
const tenant2Customers = await tenant2Db.query('customer', {})
// 返回: [{ name: '租户 2 客户', space: 'tenant_002' }]
```

**SaaS 应用:**

```typescript
// Express.js 中间件
app.use((req, res, next) => {
  const tenantId = req.headers['x-tenant-id']
  req.db = db.virtualCity(tenantId)
  next()
})

// 路由处理器使用租户特定的 db
app.get('/api/customers', async (req, res) => {
  const customers = await req.db.query('customer', {})
  res.json(customers)
})
```

## 事务支持

### transaction()

在事务中执行多个操作。

```typescript
await db.transaction(async (trx) => {
  // 所有操作使用该事务
})
```

#### 示例

```typescript
// 在客户之间转移订单
await db.transaction(async (trx) => {
  // 更新订单
  await trx.mutation('order', {
    action: 'update',
    filters: [['_id', '=', orderId]],
    data: { customer_id: newCustomerId }
  })
  
  // 记录转移日志
  await trx.mutation('audit_log', {
    action: 'insert',
    data: {
      action: 'order_transfer',
      order_id: orderId,
      old_customer: oldCustomerId,
      new_customer: newCustomerId
    }
  })
})
```

## 工具方法

### close()

关闭数据库连接并清理资源。

```typescript
await db.close(): Promise<void>
```

#### 示例

```typescript
// 优雅关闭
process.on('SIGTERM', async () => {
  await db.close()
  process.exit(0)
})
```

### getPoolStats()

获取连接池统计信息。

```typescript
const stats = await db.getPoolStats(): Promise<PoolStats>

interface PoolStats {
  total: number      // 总连接数
  idle: number       // 空闲连接数
  active: number     // 活跃连接数
  waiting: number    // 等待请求数
}
```

#### 示例

```typescript
// 监控连接池
setInterval(async () => {
  const stats = await db.getPoolStats()
  console.log('数据库池:', stats)
  
  if (stats.waiting > 10) {
    console.warn('连接等待队列过长!')
  }
}, 60000)
```

## 错误处理

ObjectQL 为不同场景抛出特定的错误类型:

```typescript
import { 
  ValidationError, 
  NotFoundError, 
  DuplicateError,
  DatabaseError 
} from '@objectql/core'

try {
  await db.mutation('customer', {
    action: 'insert',
    data: { email: 'duplicate@example.com' }
  })
} catch (error) {
  if (error instanceof ValidationError) {
    // 处理验证错误
    console.error('验证失败:', error.fields)
  } else if (error instanceof DuplicateError) {
    // 处理重复键错误
    console.error('重复:', error.field)
  } else if (error instanceof DatabaseError) {
    // 处理数据库错误
    console.error('数据库错误:', error.message)
  }
}
```

## TypeScript 支持

ObjectQL 提供完整的 TypeScript 支持和类型推断:

```typescript
import { ObjectQL, Schema } from '@objectql/core'

// 定义 Schema 类型
interface Customer {
  _id: string
  name: string
  email: string
  status: 'active' | 'inactive'
  created: Date
}

// 类型安全的查询
const customers = await db.query<Customer>('customer', {
  filters: [['status', '=', 'active']]
})

// TypeScript 知道形状
customers.forEach(customer => {
  console.log(customer.name)  // ✓ 类型安全
  console.log(customer.foo)   // ✗ 编译错误
})
```

## 下一步

- 查看[协议规范](/docs/02-objectql/protocol-spec)了解详细的查询语法
- 探索[核心功能](/docs/02-objectql/core-features)了解高级优化
- 查看[核心概念](/docs/02-objectql/core-concepts)了解基础知识
